<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeedHiveHome</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 紧凑的导航栏 */
        .navbar { padding: 0.25rem 0; }
        .navbar-brand { font-size: 1.1rem; }
        .navbar-text { font-size: 0.85rem; }
        
        /* 现代化卡片设计 */
        .status-card { 
            transition: all 0.3s; 
            border: none; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        .status-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 16px rgba(0,0,0,0.15); 
        }
        
        /* 状态卡片样式 */
        .overview-card {
            padding: 1rem;
            border-radius: 12px;
            background: white;
            border: 1px solid #e9ecef;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .overview-card .card-icon {
            font-size: 1.8rem;
            opacity: 0.8;
            flex-shrink: 0;
        }
        .overview-card .card-number {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1;
            flex-shrink: 0;
            margin: 0 1rem;
        }
        .overview-card .card-text {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
            flex: 1;
        }
        .overview-card .card-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.1rem;
            font-weight: 500;
        }
        .overview-card .card-subtitle {
            font-size: 0.75rem;
            color: #adb5bd;
        }
        
        /* 系统状态卡片 - 绿色背景 */
        .system-status-card {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        .system-status-card .card-icon {
            color: rgba(255,255,255,0.9);
        }
        .system-status-card .card-number {
            color: white;
        }
        .system-status-card .card-label {
            color: rgba(255,255,255,0.9);
        }
        .system-status-card .card-subtitle {
            color: rgba(255,255,255,0.7);
        }
        
        /* 限速状态卡片特殊样式 */
        .limit-active {
            background: linear-gradient(135deg, #dc3545, #fd7e14) !important;
        }
        .limit-inactive {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
        }
        
        /* 设备状态样式 */
        .device-online { border-left: 4px solid #198754; }
        .device-offline { border-left: 4px solid #dc3545; }
        .device-error { border-left: 4px solid #ffc107; }
        .device-disabled { border-left: 4px solid #6c757d; }
        
        /* 限速状态样式 */
        .limit-active { background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; }
        .limit-inactive { background: linear-gradient(45deg, #51cf66, #40c057); color: white; }
        
        /* 紧凑的页面布局 */
        .container { max-width: 1400px; }
        .page-header { margin-bottom: 1.5rem; }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
        }
        
        /* 设备卡片样式 */
        .device-card {
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.3s;
        }
        .device-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .device-card .device-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
        }
        .device-card .device-body {
            padding: 1rem;
        }
        
        /* 连接数显示 */
        .connection-badge { font-size: 0.8em; }
        .speed-value { font-family: 'Courier New', monospace; font-weight: bold; }
        .api-status { font-size: 0.75em; }
        .log-entry { font-family: 'Courier New', monospace; font-size: 0.8em; }
        
        .device-name-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }
        .action-buttons .btn {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background-color: #ccc;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .toggle-switch.active {
            background-color: #28a745;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        .data-badge {
            background-color: #f8f9fa;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid;
        }
        
        .status-online {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border-color: rgba(40, 167, 69, 0.3);
        }
        
        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border-color: rgba(255, 193, 7, 0.3);
        }
        
        .status-offline {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border-color: rgba(220, 53, 69, 0.3);
        }
        
        .status-unknown {
            background: rgba(108, 117, 125, 0.2);
            color: #6c757d;
            border-color: rgba(108, 117, 125, 0.3);
        }
        
        /* 固定表格列宽样式 */
        .table-fixed {
            table-layout: fixed;
            width: 100%;
        }
        
        .table-fixed th,
        .table-fixed td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0.5rem;
        }
        
        /* 设备名称列允许换行 */
        .table-fixed td:first-child {
            white-space: normal;
            word-break: break-word;
        }
        
        /* 数据徽章样式优化 */
        .table-fixed .data-badge {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* 状态徽章样式优化 */
        .table-fixed .status-badge {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .url-badge {
            background-color: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            text-decoration: none;
        }
        .url-badge:hover {
            color: white;
            text-decoration: none;
            opacity: 0.9;
        }
        .ip-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-family: 'Courier New', monospace;
        }
        .arrow-separator {
            color: #6c757d;
            font-weight: bold;
            margin: 0 0.5rem;
        }
        
        /* 固定悬浮卡片样式 */
        #overview-cards {
            position: fixed;
            top: 0; /* 显示到浏览器最顶部 */
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
            margin: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* 让悬浮卡片内容与下面表格同宽 */
        #overview-cards .container {
            max-width: none; /* 占满整个屏幕宽度，与下面表格一致 */
            margin: 0;
            padding: 0 15px;
        }
        
        /* 让4个卡片平均分配宽度 */
        #overview-cards .row {
            margin: 0;
        }
        
        #overview-cards .col-3 {
            padding: 0 8px; /* 减少卡片间距 */
        }
        
        #overview-cards .overview-card {
            width: 100%; /* 确保卡片占满分配的列宽 */
        }
        
        /* 为固定卡片调整页面内容的上边距 */
        .container {
            margin-top: 250px; /* 为固定卡片和导航栏留出空间 */
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .overview-card { height: 70px; padding: 0.75rem; }
            .overview-card .card-number { font-size: 1.8rem; margin: 0 0.5rem; }
            .overview-card .card-icon { font-size: 1.4rem; }
            .overview-card .card-label { font-size: 0.8rem; }
            .overview-card .card-subtitle { font-size: 0.7rem; }
            .action-buttons .btn {
                width: 28px;
                height: 28px;
            }
            
            /* 移动端调整固定卡片 */
            #overview-cards {
                top: 0;
                padding: 0.5rem 0;
            }
            .container {
                margin-top: 220px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-tachometer-alt me-2"></i>
                SpeedHiveHome
            </a>
            <div class="navbar-text">
                <span id="version-info" class="text-light me-3"></span>
                <span id="current-time" class="text-light"></span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- 状态概览 - 采用新的卡片设计 -->
        <div class="row mb-4" id="overview-cards">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="overview-card">
                    <div class="card-icon">
                        <i class="fas fa-satellite-dish text-primary"></i>
                    </div>
                    <div class="card-number text-primary" id="lucky-devices-count">0</div>
                    <div class="card-text">
                        <div class="card-label">Lucky 设备</div>
                        <div class="card-subtitle" id="lucky-active-count">0 个活跃</div>
                            </div>
                            </div>
                            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="overview-card">
                    <div class="card-icon">
                        <i class="fas fa-server text-success"></i>
                        </div>
                    <div class="card-number text-success" id="qbit-instances-count">0</div>
                    <div class="card-text">
                        <div class="card-label">QB 实例</div>
                        <div class="card-subtitle" id="qbit-active-count">0 个在线</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="overview-card system-status-card" id="limit-status-card">
                    <div class="card-icon">
                        <i class="fas fa-shield-alt"></i>
        </div>
                    <div class="card-number" id="connection-status">正常</div>
                    <div class="card-text">
                        <div class="card-label">限速状态</div>
                        <div class="card-subtitle" id="active-connections">无活跃连接</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="overview-card">
                    <div class="card-icon">
                        <i class="fas fa-clock text-warning"></i>
                    </div>
                    <div class="card-number text-warning" id="next-check">2s</div>
                    <div class="card-text">
                        <div class="card-label">下次检查</div>
                        <div class="card-subtitle" id="last-collection-time">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设备状态表格展示区域 -->
        <div class="row">
            <!-- Lucky设备总览 -->
            <div class="col-12 mb-4">
                <div class="card status-card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-satellite-dish me-2"></i>
                            Lucky设备总览
                        </h6>
                        <div>
                            <button class="btn btn-sm btn-outline-light me-2" onclick="refreshAllStatus()">
                                <i class="fas fa-sync-alt"></i> 刷新
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="showLuckyDeviceModal()">
                                <i class="fas fa-plus"></i> 添加设备
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="lucky-table-content">
                            <div class="text-center py-4">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2 text-muted">正在加载Lucky设备数据...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- qB客户端实体总览 -->
            <div class="col-12 mb-4">
                <div class="card status-card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-server me-2"></i>
                            qB客户端实体总览
                        </h6>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="refreshAllStatus()">
                                <i class="fas fa-sync-alt"></i> 刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="qbit-table-content">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2 text-muted">正在加载qBittorrent实例数据...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速管理入口 -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <div class="card-icon mb-3">
                            <i class="fas fa-satellite-dish text-primary" style="font-size: 2.5rem;"></i>
                        </div>
                        <h5 class="card-title">Lucky 设备管理</h5>
                        <p class="card-text text-muted">管理 Lucky 设备配置，添加、编辑或删除设备</p>
                        <button class="btn btn-primary" onclick="showLuckyDeviceModal()">
                            <i class="fas fa-plus me-2"></i>添加设备
                            </button>
                        <button class="btn btn-outline-primary ms-2" onclick="showLuckyDevicesList()">
                            <i class="fas fa-list me-2"></i>查看所有
                        </button>
                    </div>
                                </div>
                            </div>
            <div class="col-lg-6 mb-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <div class="card-icon mb-3">
                            <i class="fas fa-server text-success" style="font-size: 2.5rem;"></i>
                        </div>
                        <h5 class="card-title">qBittorrent 实例管理</h5>
                        <p class="card-text text-muted">管理 qBittorrent 实例配置，添加、编辑或删除实例</p>
                        <button class="btn btn-success" onclick="showQbitInstanceModal()">
                            <i class="fas fa-plus me-2"></i>添加实例
                        </button>
                        <button class="btn btn-outline-success ms-2" onclick="showQbitInstancesList()">
                            <i class="fas fa-list me-2"></i>查看所有
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 控制器设置 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            控制器设置
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label class="form-label small">轮询间隔 (秒)</label>
                                <input type="number" class="form-control form-control-sm" id="poll-interval" value="2" min="1" max="60">
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label class="form-label small">限速触发延迟 (秒)</label>
                                <input type="number" class="form-control form-control-sm" id="limit-on-delay" value="5" min="1" max="300">
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label class="form-label small">恢复延迟 (秒)</label>
                                <input type="number" class="form-control form-control-sm" id="limit-off-delay" value="30" min="1" max="600">
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label class="form-label small">限速下载 (KB/s)</label>
                                <input type="number" class="form-control form-control-sm" id="limited-download" value="1024" min="0">
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label class="form-label small">限速上传 (KB/s)</label>
                                <input type="number" class="form-control form-control-sm" id="limited-upload" value="512" min="0">
                        </div>
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label class="form-label small">正常下载 (KB/s)</label>
                                <input type="number" class="form-control form-control-sm" id="normal-download" value="0" min="0">
                                <small class="text-muted">0 = 不限速</small>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label class="form-label small">正常上传 (KB/s)</label>
                                <input type="number" class="form-control form-control-sm" id="normal-upload" value="0" min="0">
                                <small class="text-muted">0 = 不限速</small>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 d-flex align-items-end">
                                <button class="btn btn-primary btn-sm w-100" onclick="saveControllerSettings()">
                                    <i class="fas fa-save me-1"></i>保存设置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 调试信息 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-bug me-2"></i>
                            调试信息
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="getDebugConfig()">
                                    <i class="fas fa-cog me-1"></i>查看配置
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearLogs()">
                                    <i class="fas fa-trash me-1"></i>清空日志
                                </button>
                            </div>
                        </div>
                        <div>
                            <h6 class="small">系统日志:</h6>
                            <div class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
                                <div id="debug-logs">
                                    <div class="log-entry text-muted">等待日志信息...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lucky 设备配置模态框 -->
    <div class="modal fade" id="luckyDeviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lucky 设备配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="lucky-device-form">
                        <div class="mb-3">
                            <label class="form-label">设备名称</label>
                            <input type="text" class="form-control" id="device-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">API 地址</label>
                            <input type="url" class="form-control" id="device-api-url" 
                                   placeholder="http://192.168.1.100:16601/api/webservice/rules?openToken=YOUR_TOKEN" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">权重</label>
                            <input type="number" class="form-control" id="device-weight" value="1.0" min="0.1" max="10" step="0.1">
                            <small class="text-muted">用于多设备加权计算</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <input type="text" class="form-control" id="device-description" placeholder="设备描述（可选）">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="device-enabled" checked>
                            <label class="form-check-label" for="device-enabled">启用此设备</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveLuckyDevice()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- qBittorrent 实例配置模态框 -->
    <div class="modal fade" id="qbitInstanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">qBittorrent 实例配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="qbit-instance-form">
                        <div class="mb-3">
                            <label class="form-label">实例名称</label>
                            <input type="text" class="form-control" id="instance-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">主机地址</label>
                            <input type="url" class="form-control" id="instance-host" 
                                   placeholder="http://192.168.1.200:8080" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-control" id="instance-username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">密码</label>
                            <input type="password" class="form-control" id="instance-password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <input type="text" class="form-control" id="instance-description" placeholder="实例描述（可选）">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="instance-enabled" checked>
                            <label class="form-check-label" for="instance-enabled">启用此实例</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="saveQbitInstance()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-light py-3 mt-5">
        <div class="container text-center">
            <small id="footer-version">SpeedHiveHome | 实时监控与智能限速</small>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        class QBControllerDashboard {
            constructor() {
                this.config = null;
                this.lastUpdate = new Date();
                this.updateInterval = null;
                this.logEntries = [];
                this.init();
            }

            init() {
                this.updateCurrentTime();
                this.loadVersionInfo();
                this.loadConfig();
                this.startStatusUpdates();
                this.addLog('系统初始化完成', 'info');
                
                setInterval(() => {
                    this.updateCurrentTime();
                }, 1000);
            }

            updateCurrentTime() {
                const now = new Date();
                document.getElementById('current-time').textContent = 
                    now.toLocaleString('zh-CN');
            }

            async loadVersionInfo() {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    
                    // 更新导航栏版本信息
                    const versionElement = document.getElementById('version-info');
                    if (versionElement && data.version_string) {
                        versionElement.textContent = `v${data.version}`;
                        versionElement.title = data.version_string;
                    }
                    
                    // 更新页脚版本信息
                    const footerElement = document.getElementById('footer-version');
                    if (footerElement && data.version_string) {
                        footerElement.innerHTML = `SpeedHiveHome v${data.version} | 实时监控与智能限速`;
                    }
                    
                    // 更新页面标题
                    document.title = `SpeedHiveHome v${data.version}`;
                    
                    this.addLog(`版本信息加载完成: ${data.version_string}`, 'info');
                } catch (error) {
                    console.error('加载版本信息失败:', error);
                    this.addLog('版本信息加载失败', 'error');
                }
            }

            async loadConfig() {
                try {
                    const response = await fetch('/api/config');
                    this.config = await response.json();
                    this.addLog('配置加载成功', 'success');
                    this.renderConfigSections();
                } catch (error) {
                    this.addLog('配置加载失败: ' + error, 'error');
                    console.error('加载配置失败:', error);
                }
            }

            renderConfigSections() {
                this.renderControllerSettings();
            }


            renderControllerSettings() {
                const settings = this.config.controller_settings || {};
                document.getElementById('poll-interval').value = settings.poll_interval || 2;
                document.getElementById('limit-on-delay').value = settings.limit_on_delay || 5;
                document.getElementById('limit-off-delay').value = settings.limit_off_delay || 30;
                document.getElementById('limited-download').value = settings.limited_download || 1024;
                document.getElementById('limited-upload').value = settings.limited_upload || 512;
                document.getElementById('normal-download').value = settings.normal_download || 0;
                document.getElementById('normal-upload').value = settings.normal_upload || 0;
            }

            async startStatusUpdates() {
                await this.updateStatus();
                this.updateInterval = setInterval(() => {
                    this.updateStatus();
                }, 2000);
            }

            async updateStatus() {
                try {
                    this.addLog('开始采集状态数据...', 'info');
                    const [luckyStatus, qbitStatus, controllerState] = await Promise.all([
                        fetch('/api/lucky/status').then(r => r.json()),
                        fetch('/api/qbit/status').then(r => r.json()),
                        fetch('/api/controller/state').then(r => r.json())
                    ]);

                    this.renderDevicesTable(luckyStatus, qbitStatus);
                    this.updateOverview(luckyStatus, qbitStatus, controllerState);
                    this.lastUpdate = new Date();
                    
                    const lastUpdateElement = document.getElementById('last-update-time');
                    if (lastUpdateElement) {
                        lastUpdateElement.textContent = this.lastUpdate.toLocaleTimeString('zh-CN');
                    }
                    const lastCollectionElement = document.getElementById('last-collection-time');
                    if (lastCollectionElement) {
                        lastCollectionElement.textContent = this.lastUpdate.toLocaleTimeString('zh-CN');
                    }
                        
                    this.addLog('状态数据采集完成', 'success');
                } catch (error) {
                    this.addLog('状态更新失败: ' + error, 'error');
                    console.error('状态更新失败:', error);
                }
            }

            renderQbitTable(qbitStatus) {
                const container = document.getElementById('qbit-table-content');
                
                if (!qbitStatus.instances || qbitStatus.instances.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>暂无qBittorrent实例数据</p>
                                    </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 table-fixed">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">设备名称</th>
                                    <th style="width: 18%;">连接状态</th>
                                    <th style="width: 18%;">下行速度</th>
                                    <th style="width: 18%;">上行速度</th>
                                    <th style="width: 18%;">做种总数</th>
                                    <th style="width: 18%;">活动数量</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                qbitStatus.instances.forEach((instance, index) => {
                    if (instance.success) {
                        // 格式化数据大小
                        const formatBytes = (bytes) => {
                            if (bytes === 0) return '0 B';
                            const k = 1024;
                            const sizes = ['B', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                        };
                        
                        // 获取连接状态显示
                        const status = instance.connection_status || 'unknown';
                        let statusClass = '';
                        let statusIcon = '';
                        let statusText = '';
                        
                        switch (status) {
                            case 'connected':
                                statusClass = 'status-online';
                                statusIcon = 'fas fa-check-circle';
                                statusText = '已连接';
                                break;
                            case 'firewalled':
                                statusClass = 'status-warning';
                                statusIcon = 'fas fa-shield-alt';
                                statusText = '防火墙';
                                break;
                            case 'disconnected':
                                statusClass = 'status-offline';
                                statusIcon = 'fas fa-times-circle';
                                statusText = '未连接';
                                break;
                            default:
                                statusClass = 'status-unknown';
                                statusIcon = 'fas fa-question-circle';
                                statusText = '未知';
                        }
                        
                        html += `
                            <tr>
                                <td>
                                    <span class="device-name-badge">${instance.remark || instance.instance_name}</span>
                                </td>
                                <td>
                                    <span class="status-badge ${statusClass}">
                                        <i class="${statusIcon}"></i>
                                        ${statusText}
                                                </span>
                                </td>
                                <td>
                                    <span class="data-badge">
                                        <i class="fas fa-arrow-down"></i>
                                        ${formatBytes(instance.download_speed || 0)}
                                    </span>
                                </td>
                                <td>
                                    <span class="data-badge">
                                        <i class="fas fa-arrow-up"></i>
                                        ${formatBytes(instance.upload_speed || 0)}
                                    </span>
                                </td>
                                <td>
                                    <span class="data-badge">
                                        <i class="fas fa-seedling"></i>
                                        ${instance.total_torrents || 0}
                                    </span>
                                </td>
                                <td>
                                    <span class="data-badge">
                                        <i class="fas fa-play-circle"></i>
                                        ${(instance.active_seeds || 0) + (instance.active_downloads || 0)}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                    container.innerHTML = html;
            }

            renderLuckyTable(luckyStatus) {
                const container = document.getElementById('lucky-table-content');
                let proxyServices = [];
                
                // 调试信息：打印接收到的数据结构
                console.log('Lucky Status Data:', luckyStatus);
                
                // 处理Lucky设备，提取ProxyList中的详细服务信息
                if (luckyStatus.devices && luckyStatus.devices.length > 0) {
                    let totalServices = 0;
                    let enabledServices = 0;
                    
                    luckyStatus.devices.forEach(device => {
                        console.log('Device:', device);
                        console.log('Device raw_data:', device.raw_data);
                        
                        if (device.success && device.raw_data) {
                            // 使用正确的数据结构：ruleList[0].ProxyList
                            let ruleList = device.raw_data.ruleList;
                            let statistics = device.raw_data.statistics || {};
                            
                            console.log('RuleList found:', ruleList);
                            console.log('Statistics found:', statistics);
                            
                            if (Array.isArray(ruleList) && ruleList.length > 0) {
                                // 从第一个规则中获取ProxyList
                                let proxyList = ruleList[0].ProxyList || [];
                                let ruleKey = ruleList[0].RuleKey || '';
                                
                                console.log(`Found rule: ${ruleList[0].RuleName} (Key: ${ruleKey})`);
                                console.log(`Found ${proxyList.length} services in ProxyList`);
                                
                                if (Array.isArray(proxyList)) {
                                    totalServices += proxyList.length;
                                    
                                    proxyList.forEach((proxy, index) => {
                                        console.log(`=== Processing proxy ${index} ===`);
                                        console.log('Full proxy object:', JSON.stringify(proxy, null, 2));
                                        console.log('Service Enable:', proxy.Enable);
                                        console.log('Service Remark:', proxy.Remark);
                                        console.log('Service Key:', proxy.Key);
                                        console.log('Service WebServiceType:', proxy.WebServiceType);
                                        console.log('Service Locations:', proxy.Locations);
                                        console.log('Service Domains:', proxy.Domains);
                                        
                                        // 显示所有启用的服务
                                        if (proxy.Enable) {
                                            enabledServices++;
                                        // 从statistics中获取该服务的连接和速度信息
                                        const proxyKey = proxy.Key;
                                        const ruleStats = statistics[ruleKey] || {};
                                        const proxyStats = ruleStats.ProxyList || {};
                                        const stats = proxyStats[proxyKey] || {};
                                        
                                        console.log(`Statistics for ${proxyKey}:`, stats);
                                        
                                        // 尝试不同的字段名获取服务名称
                                        const serviceName = proxy.Remark || 
                                                           proxy.RuleName || 
                                                           proxy.Name || 
                                                           proxy.ServiceName ||
                                                           proxy.Key ||
                                                           '未命名服务';
                                        
                                        // 尝试不同的字段名获取地址和域名
                                        const locations = proxy.Locations || 
                                                        proxy.Targets || 
                                                        proxy.Target || 
                                                        proxy.Upstreams ||
                                                        [];
                                        
                                        const domains = proxy.Domains || 
                                                      proxy.Domain || 
                                                      proxy.Hosts ||
                                                      [];
                                        
                                        console.log(`Service name resolved: ${serviceName}`);
                                        console.log(`Locations resolved:`, locations);
                                        console.log(`Domains resolved:`, domains);
                                        
                                        proxyServices.push({
                                            device_name: device.device_name,
                                            service_name: serviceName,
                                            service_type: proxy.WebServiceType || 'unknown',
                                            enabled: proxy.Enable,
                                            key: proxy.Key,
                                            locations: locations,
                                            domains: domains,
                                            // 从statistics获取连接数和速度
                                            connections: stats.Connections || 0,
                                            download_speed: stats.InSpeed || 0,
                                            upload_speed: stats.OutSpeed || 0,
                                            download_bytes: stats.TrafficIn || 0,
                                            upload_bytes: stats.TrafficOut || 0,
                                            last_update: device.last_update
                                        });
                                        }
                                    });
                                }
                            }
                        }
                    });
                }
                
                if (proxyServices.length === 0) {
                    let debugInfo = '';
                    if (luckyStatus.devices && luckyStatus.devices.length > 0) {
                        debugInfo = `<br><small class="text-muted">调试信息: 找到 ${luckyStatus.devices.length} 个设备</small>`;
                        luckyStatus.devices.forEach((device, index) => {
                            debugInfo += `<br><small class="text-muted">设备${index + 1}: ${device.device_name} - 成功: ${device.success}</small>`;
                            if (device.raw_data) {
                                debugInfo += `<br><small class="text-muted">raw_data字段: ${Object.keys(device.raw_data).join(', ')}</small>`;
                                if (device.raw_data.ruleList) {
                                    debugInfo += `<br><small class="text-muted">ruleList数量: ${device.raw_data.ruleList.length}</small>`;
                                    const enabledServices = device.raw_data.ruleList.filter(rule => rule.Enable);
                                    debugInfo += `<br><small class="text-muted">启用服务数量: ${enabledServices.length}</small>`;
                                    debugInfo += `<br><small class="text-muted">实际处理服务数量: ${proxyServices.length}</small>`;
                                }
                            }
                        });
                    }
                    
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>暂无Lucky代理服务数据</p>
                            <p>请检查Lucky设备配置和API连接</p>
                            ${debugInfo}
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 table-fixed">
                            <thead>
                                <tr>
                                    <th style="width: 20%;">服务名称</th>
                                    <th style="width: 12%;">状态控制</th>
                                    <th style="width: 12%;">连接数</th>
                                    <th style="width: 15%;">下行速度</th>
                                    <th style="width: 15%;">上行速度</th>
                                    <th style="width: 20%;">目标地址</th>
                                    <th style="width: 20%;">域名</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                proxyServices.forEach((service, index) => {
                    // 格式化地址显示
                    const formatLocations = (locations) => {
                        if (!locations || locations.length === 0) return '无';
                        return locations.slice(0, 2).join(', ') + (locations.length > 2 ? '...' : '');
                    };
                    
                    // 格式化域名显示
                    const formatDomains = (domains) => {
                        if (!domains || domains.length === 0) return '无';
                        return domains.slice(0, 2).join(', ') + (domains.length > 2 ? '...' : '');
                    };
                    
                    // 获取服务类型图标
                    const getServiceIcon = (serviceType) => {
                        switch (serviceType) {
                            case 'reverseproxy': return 'fas fa-exchange-alt';
                            case 'fileserver': return 'fas fa-folder-open';
                            case 'tcp': return 'fas fa-plug';
                            case 'udp': return 'fas fa-broadcast-tower';
                            default: return 'fas fa-cog';
                        }
                    };
                    
                    html += `
                        <tr>
                            <td>
                                <span class="device-name-badge">${service.service_name}</span>
                            </td>
                            <td>
                                <div class="status-toggle">
                                    <div class="toggle-switch ${service.enabled ? 'active' : ''}" onclick="toggleLuckyServiceControl('${service.key}')" title="控制该服务是否参与qB限速逻辑">
                                    </div>
                                    <span class="small">${service.enabled ? '启用' : '禁用'}</span>
                                </div>
                            </td>
                            <td>
                                <span class="data-badge ${service.connections > 0 ? 'badge-success' : ''}">
                                    <i class="fas fa-link"></i>
                                    ${service.connections}
                                </span>
                            </td>
                            <td>
                                <span class="data-badge">
                                    <i class="fas fa-download"></i>
                                    ${this.formatSpeed(service.download_speed)}
                                </span>
                            </td>
                            <td>
                                <span class="data-badge">
                                    <i class="fas fa-upload"></i>
                                    ${this.formatSpeed(service.upload_speed)}
                                </span>
                            </td>
                            <td>
                                <span class="data-badge" title="${service.locations.join(', ')}">
                                    <i class="fas fa-server"></i>
                                    ${formatLocations(service.locations)}
                                </span>
                            </td>
                            <td>
                                <span class="data-badge" title="${service.domains.join(', ')}">
                                    <i class="fas fa-globe"></i>
                                    ${formatDomains(service.domains)}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = html;
            }

            renderDevicesTable(luckyStatus, qbitStatus) {
                // 分别渲染两个表格
                this.renderQbitTable(qbitStatus);
                this.renderLuckyTable(luckyStatus);
            }

            renderLuckyStatus(status) {
                // 这个方法现在被renderDevicesTable替代，主要用于显示qBittorrent实例状态
                this.renderDevicesTable(status, { instances: [] });
            }

            getLuckyStatusClass(device) {
                if (!device.success) return 'device-error';
                if (device.status === 'online') return 'device-online';
                if (device.status === 'disabled') return 'device-disabled';
                return 'device-offline';
            }

            getLuckyStatusText(device) {
                if (!device.success) return '错误';
                if (device.status === 'online') return '在线';
                if (device.status === 'disabled') return '禁用';
                return '离线';
            }

            getLuckyStatusBadge(device) {
                if (!device.success) return 'bg-warning';
                if (device.status === 'online') return 'bg-success';
                if (device.status === 'disabled') return 'bg-secondary';
                return 'bg-danger';
            }

            getQbitStatusClass(instance) {
                if (!instance.success) return 'instance-error';
                if (instance.status === 'online') return 'instance-online';
                if (instance.status === 'offline') return 'instance-offline';
                return 'instance-error';
            }

            getQbitStatusText(instance) {
                if (!instance.success) return '错误';
                if (instance.status === 'online') return '在线';
                if (instance.status === 'offline') return '离线';
                return '异常';
            }

            getQbitStatusBadge(instance) {
                if (!instance.success) return 'bg-warning';
                if (instance.status === 'online') return 'bg-success';
                if (instance.status === 'offline') return 'bg-danger';
                return 'bg-warning';
            }

            renderQbitStatus(status) {
                const container = document.getElementById('qbit-status-content');
                if (status.instances && status.instances.length > 0) {
                    let html = '';
                    status.instances.forEach((instance, index) => {
                        const isOnline = instance.success && instance.status === 'online';
                        const statusBadge = this.getQbitStatusBadge(instance);
                        const statusText = this.getQbitStatusText(instance);
                        
                        html += `
                            <div class="device-card">
                                <div class="device-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">${instance.instance_name}</h6>
                                        <span class="badge ${statusBadge}">${statusText}</span>
                                    </div>
                                </div>
                                <div class="device-body">
                                    ${isOnline ? `
                                        <div class="row text-center">
                                            <div class="col-6 border-end">
                                                <small class="text-muted d-block">下载</small>
                                                <span class="speed-value text-primary">${this.formatSpeed(instance.download_speed)}</span>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted d-block">上传</small>
                                                <span class="speed-value text-success">${this.formatSpeed(instance.upload_speed)}</span>
                                            </div>
                                        </div>
                                        <div class="row text-center mt-2">
                                            <div class="col-4 border-end">
                                                <small class="text-muted d-block">下载中</small>
                                                <span class="fw-bold">${instance.active_downloads}</span>
                                            </div>
                                            <div class="col-4 border-end">
                                                <small class="text-muted d-block">做种中</small>
                                                <span class="fw-bold">${instance.active_seeds}</span>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted d-block">总任务</small>
                                                <span class="fw-bold">${instance.total_torrents}</span>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted api-status">
                                                最后更新: ${new Date(instance.last_update).toLocaleTimeString('zh-CN')}
                                            </small>
                                        </div>
                                    ` : `
                                        <div class="row text-center">
                                            <div class="col-6 border-end">
                                                <small class="text-muted d-block">下载</small>
                                                <span class="speed-value text-muted">${this.formatSpeed(instance.download_speed || 0)}</span>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted d-block">上传</small>
                                                <span class="speed-value text-muted">${this.formatSpeed(instance.upload_speed || 0)}</span>
                                            </div>
                                        </div>
                                        <div class="row text-center mt-2">
                                            <div class="col-4 border-end">
                                                <small class="text-muted d-block">下载中</small>
                                                <span class="fw-bold text-muted">${instance.active_downloads || 0}</span>
                                            </div>
                                            <div class="col-4 border-end">
                                                <small class="text-muted d-block">做种中</small>
                                                <span class="fw-bold text-muted">${instance.active_seeds || 0}</span>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted d-block">总任务</small>
                                                <span class="fw-bold text-muted">${instance.total_torrents || 0}</span>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-exclamation-triangle me-1"></i> ${instance.error || '离线'}
                                            </small>
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>未配置 qBittorrent 实例</p>
                        </div>
                    `;
                }
            }

            formatSpeed(bytes) {
                if (bytes === 0) return '0 B/s';
                const k = 1024;
                const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            updateOverview(luckyStatus, qbitStatus, controllerState) {
                // Lucky 设备统计
                const luckyDevices = luckyStatus.devices || [];
                const activeLuckyDevices = luckyDevices.filter(d => d.success && d.status === 'online').length;
                
                const luckyDevicesCountElement = document.getElementById('lucky-devices-count');
                if (luckyDevicesCountElement) {
                    luckyDevicesCountElement.textContent = luckyDevices.length;
                }
                const luckyActiveCountElement = document.getElementById('lucky-active-count');
                if (luckyActiveCountElement) {
                    luckyActiveCountElement.textContent = `${activeLuckyDevices} 个活跃`;
                }

                // QB 实例统计
                const qbitInstances = qbitStatus.instances || [];
                const activeQbitInstances = qbitInstances.filter(i => i.success && i.status === 'online').length;
                
                const qbitInstancesCountElement = document.getElementById('qbit-instances-count');
                if (qbitInstancesCountElement) {
                    qbitInstancesCountElement.textContent = qbitInstances.length;
                }
                const qbitActiveCountElement = document.getElementById('qbit-active-count');
                if (qbitActiveCountElement) {
                    qbitActiveCountElement.textContent = `${activeQbitInstances} 个在线`;
                }

                // 控制器状态（使用真实的控制器数据）
                const statusElement = document.getElementById('connection-status');
                const statusCard = document.getElementById('limit-status-card');
                const activeConnElement = document.getElementById('active-connections');
                
                if (controllerState && statusElement && statusCard && activeConnElement) {
                    const isLimited = controllerState.is_limited;
                    const totalConnections = controllerState.total_connections || 0;
                    const limitTimer = controllerState.limit_timer || 0;
                    const normalTimer = controllerState.normal_timer || 0;
                    
                    if (isLimited) {
                        statusElement.textContent = '限速中';
                        statusCard.className = 'card status-card limit-active';
                        activeConnElement.textContent = `${totalConnections.toFixed(1)} 个加权连接`;
                    } else {
                        statusElement.textContent = '正常';
                        statusCard.className = 'card status-card limit-inactive';
                        
                        if (totalConnections > 0) {
                            activeConnElement.textContent = `检测到连接，倒计时 ${limitTimer.toFixed(0)}s`;
                        } else if (normalTimer > 0) {
                            activeConnElement.textContent = `恢复倒计时 ${normalTimer.toFixed(0)}s`;
                        } else {
                            activeConnElement.textContent = '无活跃连接';
                        }
                        }
                    }
                    
                // 更新服务状态（如果元素存在）
                    const serviceStatus = document.getElementById('service-status');
                if (serviceStatus && controllerState) {
                    if (controllerState.running) {
                        serviceStatus.className = 'badge bg-success';
                        serviceStatus.textContent = '运行中';
                    } else {
                        serviceStatus.className = 'badge bg-danger';
                        serviceStatus.textContent = '已停止';
                    }
                }

                this.updateNextCheck();
            }

            updateNextCheck() {
                const nextCheck = document.getElementById('next-check');
                let count = 2;
                
                const countdown = setInterval(() => {
                    nextCheck.textContent = count + 's';
                    count--;
                    
                    if (count < 0) {
                        clearInterval(countdown);
                    }
                }, 1000);
            }

            addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('zh-CN');
                const typeIcon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
                const typeClass = type === 'success' ? 'text-success' : type === 'error' ? 'text-danger' : type === 'warning' ? 'text-warning' : 'text-info';
                
                const logEntry = {
                    timestamp,
                    message,
                    type,
                    typeIcon,
                    typeClass
                };
                
                this.logEntries.unshift(logEntry);
                
                // 保持最多50条日志
                if (this.logEntries.length > 50) {
                    this.logEntries.pop();
                }
                
                this.renderLogs();
            }

            renderLogs() {
                const container = document.getElementById('debug-logs');
                let html = '';
                
                this.logEntries.forEach(entry => {
                    html += `
                        <div class="log-entry ${entry.typeClass}">
                            <small>[${entry.timestamp}] ${entry.typeIcon} ${entry.message}</small>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        }

        // 全局函数
        async function refreshAllStatus() {
            window.dashboard.addLog('手动刷新所有状态...', 'info');
            const container = document.getElementById('devices-table-content');
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2 text-muted">刷新中...</p>
                </div>
            `;
            await window.dashboard.updateStatus();
        }

        async function refreshLuckyStatus() {
            window.dashboard.addLog('手动刷新Lucky状态...', 'info');
            await window.dashboard.updateStatus();
        }

        async function refreshQbitStatus() {
            window.dashboard.addLog('手动刷新QB状态...', 'info');
            const container = document.getElementById('qbit-status-content');
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2 text-muted">刷新中...</p>
                </div>
            `;
            await window.dashboard.updateStatus();
        }

        async function testLuckyConnection(index) {
            try {
                window.dashboard.addLog('测试Lucky连接...', 'info');
                const response = await fetch(`/api/test/lucky/${index}`);
                const result = await response.json();
                
                if (result.success) {
                    window.dashboard.addLog(`Lucky连接测试成功: ${result.message}`, 'success');
                    alert(`✅ Lucky连接测试成功:\n${result.message}`);
                } else {
                    window.dashboard.addLog(`Lucky连接测试失败: ${result.message}`, 'error');
                    alert(`❌ Lucky连接测试失败:\n${result.message}`);
                }
            } catch (error) {
                window.dashboard.addLog(`Lucky连接测试错误: ${error}`, 'error');
                alert(`❌ Lucky连接测试错误:\n${error}`);
            }
        }

        async function testQbitConnection(index) {
            try {
                window.dashboard.addLog('测试QB连接...', 'info');
                const response = await fetch(`/api/test/qbit/${index}`);
                const result = await response.json();
                
                if (result.success) {
                    window.dashboard.addLog(`QB连接测试成功: ${result.message}`, 'success');
                    alert(`✅ QB连接测试成功:\n${result.message}`);
                } else {
                    window.dashboard.addLog(`QB连接测试失败: ${result.message}`, 'error');
                    alert(`❌ QB连接测试失败:\n${result.message}`);
                }
            } catch (error) {
                window.dashboard.addLog(`QB连接测试错误: ${error}`, 'error');
                alert(`❌ QB连接测试错误:\n${error}`);
            }
        }

        async function getDebugConfig() {
            try {
                const response = await fetch('/api/debug/config');
                const result = await response.json();
                window.dashboard.addLog('获取调试配置成功', 'success');
                alert('调试配置信息已查看，请查看控制台日志');
                console.log('调试配置:', result);
            } catch (error) {
                window.dashboard.addLog('获取调试配置失败: ' + error, 'error');
                alert('获取调试配置失败: ' + error);
            }
        }

        function clearLogs() {
            window.dashboard.logEntries = [];
            window.dashboard.renderLogs();
            window.dashboard.addLog('日志已清空', 'info');
        }

        // 配置管理函数
        function showLuckyDeviceModal() {
            const form = document.getElementById('lucky-device-form');
            const modal = new bootstrap.Modal(document.getElementById('luckyDeviceModal'));
            
            // 清除表单和编辑标记
            form.reset();
            delete form.dataset.editIndex;
            
            // 设置默认值
            document.getElementById('device-weight').value = '1.0';
            document.getElementById('device-enabled').checked = true;
            
            modal.show();
        }

        function showLuckyDevicesList() {
            const devices = window.dashboard.config.lucky_devices || [];
            let html = '<div class="modal fade" id="luckyDevicesListModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Lucky 设备列表</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">';
            
            if (devices.length === 0) {
                html += '<div class="text-center py-4 text-muted"><i class="fas fa-satellite-dish fa-2x mb-2"></i><p>暂无 Lucky 设备</p></div>';
            } else {
                devices.forEach((device, index) => {
                    const statusClass = device.enabled ? 'success' : 'secondary';
                    const statusText = device.enabled ? '启用' : '禁用';
                    
                    html += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">${device.name}</h6>
                                    <span class="badge bg-${statusClass}">${statusText}</span>
                                </div>
                                <p class="text-muted mb-2">
                                    <small>API: ${device.api_url}</small><br>
                                    <small>权重: ${device.weight}</small>
                                </p>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editLuckyDevice(${index}); bootstrap.Modal.getInstance(document.getElementById('luckyDevicesListModal')).hide();">
                                        <i class="fas fa-edit"></i> 编辑
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteLuckyDevice(${index}); bootstrap.Modal.getInstance(document.getElementById('luckyDevicesListModal')).hide();">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                    <button class="btn btn-outline-info" onclick="testLuckyConnection(${index})">
                                        <i class="fas fa-plug"></i> 测试
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button></div></div></div></div>';
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('luckyDevicesListModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新的模态框
            document.body.insertAdjacentHTML('beforeend', html);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('luckyDevicesListModal'));
            modal.show();
        }

        function showQbitInstancesList() {
            const instances = window.dashboard.config.qbittorrent_instances || [];
            let html = '<div class="modal fade" id="qbitInstancesListModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">qBittorrent 实例列表</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">';
            
            if (instances.length === 0) {
                html += '<div class="text-center py-4 text-muted"><i class="fas fa-server fa-2x mb-2"></i><p>暂无 qBittorrent 实例</p></div>';
            } else {
                instances.forEach((instance, index) => {
                    const statusClass = instance.enabled ? 'success' : 'secondary';
                    const statusText = instance.enabled ? '启用' : '禁用';
                    
                    html += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">${instance.name}</h6>
                                    <span class="badge bg-${statusClass}">${statusText}</span>
                                </div>
                                <p class="text-muted mb-2">
                                    <small>地址: ${instance.host}</small><br>
                                    <small>用户: ${instance.username}</small>
                                </p>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editQbitInstance(${index}); bootstrap.Modal.getInstance(document.getElementById('qbitInstancesListModal')).hide();">
                                        <i class="fas fa-edit"></i> 编辑
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteQbitInstance(${index}); bootstrap.Modal.getInstance(document.getElementById('qbitInstancesListModal')).hide();">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                    <button class="btn btn-outline-info" onclick="testQbitConnection(${index})">
                                        <i class="fas fa-plug"></i> 测试
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button></div></div></div></div>';
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('qbitInstancesListModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新的模态框
            document.body.insertAdjacentHTML('beforeend', html);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('qbitInstancesListModal'));
            modal.show();
        }


        function toggleDeviceControl(index) {
            // 这里应该控制该设备是否参与qB限速逻辑
            // 可以通过API调用来更新设备的控制状态
            window.dashboard.addLog(`设备控制状态已切换 (索引: ${index})`, 'info');
            
            // 更新开关状态
            const toggleSwitch = event.target;
            toggleSwitch.classList.toggle('active');
            const statusText = toggleSwitch.nextElementSibling;
            const isActive = toggleSwitch.classList.contains('active');
            statusText.textContent = isActive ? '开' : '关';
            
            // 这里可以添加API调用来保存控制状态
            // 例如: await fetch('/api/device/control', { method: 'POST', body: JSON.stringify({index, enabled: isActive}) });
        }

        function toggleLuckyServiceControl(serviceKey) {
            // 控制Lucky服务是否参与qB限速逻辑
            window.dashboard.addLog(`Lucky服务控制状态已切换 (Key: ${serviceKey})`, 'info');
            
            // 更新开关状态
            const toggleSwitch = event.target;
            toggleSwitch.classList.toggle('active');
            const statusText = toggleSwitch.nextElementSibling;
            const isActive = toggleSwitch.classList.contains('active');
            statusText.textContent = isActive ? '启用' : '禁用';
            
            // 这里可以添加API调用来保存Lucky服务的控制状态
            // 例如: await fetch('/api/lucky/service/control', { method: 'POST', body: JSON.stringify({key: serviceKey, enabled: isActive}) });
        }

        function toggleDeviceStatus(index) {
            const devices = window.dashboard.config.lucky_devices || [];
            if (devices[index]) {
                devices[index].enabled = !devices[index].enabled;
                // 这里可以添加保存配置的逻辑
                window.dashboard.addLog(`设备 ${devices[index].name} 状态已切换为 ${devices[index].enabled ? '启用' : '禁用'}`, 'info');
            }
        }

        function showQbitInstanceModal() {
            const form = document.getElementById('qbit-instance-form');
            const modal = new bootstrap.Modal(document.getElementById('qbitInstanceModal'));
            
            // 清除表单和编辑标记
            form.reset();
            delete form.dataset.editIndex;
            
            // 设置默认值
            document.getElementById('instance-enabled').checked = true;
            
            modal.show();
        }

        async function saveLuckyDevice() {
            const form = document.getElementById('lucky-device-form');
            const editIndex = form.dataset.editIndex;
            
            const device = {
                name: document.getElementById('device-name').value,
                api_url: document.getElementById('device-api-url').value,
                weight: parseFloat(document.getElementById('device-weight').value),
                enabled: document.getElementById('device-enabled').checked,
                description: document.getElementById('device-description').value
            };

            try {
                let devices = [...(window.dashboard.config.lucky_devices || [])];
                
                // 检查是否是编辑模式
                if (editIndex !== undefined && editIndex !== null && editIndex !== '') {
                    // 编辑模式：更新现有设备
                    devices[parseInt(editIndex)] = device;
                    window.dashboard.addLog(`编辑 Lucky 设备: ${device.name}`, 'info');
                } else {
                    // 添加模式：新增设备
                    devices.push(device);
                    window.dashboard.addLog(`添加 Lucky 设备: ${device.name}`, 'info');
                }
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...window.dashboard.config,
                        lucky_devices: devices
                    })
                });

                if (response.ok) {
                    window.dashboard.addLog('Lucky 设备保存成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('luckyDeviceModal')).hide();
                    // 清除编辑标记
                    delete form.dataset.editIndex;
                    await window.dashboard.loadConfig();
                } else {
                    throw new Error('保存失败');
                }
            } catch (error) {
                window.dashboard.addLog('Lucky 设备保存失败: ' + error.message, 'error');
            }
        }

        async function saveQbitInstance() {
            const form = document.getElementById('qbit-instance-form');
            const editIndex = form.dataset.editIndex;
            
            const instance = {
                name: document.getElementById('instance-name').value,
                host: document.getElementById('instance-host').value,
                username: document.getElementById('instance-username').value,
                password: document.getElementById('instance-password').value,
                enabled: document.getElementById('instance-enabled').checked,
                description: document.getElementById('instance-description').value
            };

            try {
                let instances = [...(window.dashboard.config.qbittorrent_instances || [])];
                
                // 检查是否是编辑模式
                if (editIndex !== undefined && editIndex !== null && editIndex !== '') {
                    // 编辑模式：更新现有实例
                    instances[parseInt(editIndex)] = instance;
                    window.dashboard.addLog(`编辑 qBittorrent 实例: ${instance.name}`, 'info');
                } else {
                    // 添加模式：新增实例
                    instances.push(instance);
                    window.dashboard.addLog(`添加 qBittorrent 实例: ${instance.name}`, 'info');
                }
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...window.dashboard.config,
                        qbittorrent_instances: instances
                    })
                });

                if (response.ok) {
                    window.dashboard.addLog('qBittorrent 实例保存成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('qbitInstanceModal')).hide();
                    // 清除编辑标记
                    delete form.dataset.editIndex;
                    await window.dashboard.loadConfig();
                } else {
                    throw new Error('保存失败');
                }
            } catch (error) {
                window.dashboard.addLog('qBittorrent 实例保存失败: ' + error.message, 'error');
            }
        }

        async function saveControllerSettings() {
            const settings = {
                poll_interval: parseInt(document.getElementById('poll-interval').value),
                limit_on_delay: parseInt(document.getElementById('limit-on-delay').value),
                limit_off_delay: parseInt(document.getElementById('limit-off-delay').value),
                limited_download: parseInt(document.getElementById('limited-download').value),
                limited_upload: parseInt(document.getElementById('limited-upload').value),
                normal_download: parseInt(document.getElementById('normal-download').value),
                normal_upload: parseInt(document.getElementById('normal-upload').value)
            };

            try {
                const response = await fetch('/api/config/controller', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    window.dashboard.addLog('控制器设置保存成功', 'success');
                    await window.dashboard.loadConfig();
                } else {
                    throw new Error('保存失败');
                }
            } catch (error) {
                window.dashboard.addLog('控制器设置保存失败: ' + error.message, 'error');
            }
        }

        function editLuckyDevice(index) {
            const device = window.dashboard.config.lucky_devices[index];
            const modal = new bootstrap.Modal(document.getElementById('luckyDeviceModal'));
            
            document.getElementById('device-name').value = device.name;
            document.getElementById('device-api-url').value = device.api_url;
            document.getElementById('device-weight').value = device.weight;
            document.getElementById('device-enabled').checked = device.enabled;
            document.getElementById('device-description').value = device.description || '';
            
            // 标记为编辑模式
            document.getElementById('lucky-device-form').dataset.editIndex = index;
            modal.show();
        }

        function editQbitInstance(index) {
            const instance = window.dashboard.config.qbittorrent_instances[index];
            const modal = new bootstrap.Modal(document.getElementById('qbitInstanceModal'));
            
            document.getElementById('instance-name').value = instance.name;
            document.getElementById('instance-host').value = instance.host;
            document.getElementById('instance-username').value = instance.username;
            document.getElementById('instance-password').value = instance.password;
            document.getElementById('instance-enabled').checked = instance.enabled;
            document.getElementById('instance-description').value = instance.description || '';
            
            // 标记为编辑模式
            document.getElementById('qbit-instance-form').dataset.editIndex = index;
            modal.show();
        }

        async function deleteLuckyDevice(index) {
            if (!confirm('确定要删除这个 Lucky 设备吗？')) return;
            
            const devices = [...window.dashboard.config.lucky_devices];
            devices.splice(index, 1);
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...window.dashboard.config,
                        lucky_devices: devices
                    })
                });

                if (response.ok) {
                    window.dashboard.addLog('Lucky 设备删除成功', 'success');
                    await window.dashboard.loadConfig();
                } else {
                    throw new Error('删除失败');
                }
            } catch (error) {
                window.dashboard.addLog('Lucky 设备删除失败: ' + error.message, 'error');
            }
        }

        async function deleteQbitInstance(index) {
            if (!confirm('确定要删除这个 qBittorrent 实例吗？')) return;
            
            const instances = [...window.dashboard.config.qbittorrent_instances];
            instances.splice(index, 1);
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...window.dashboard.config,
                        qbittorrent_instances: instances
                    })
                });

                if (response.ok) {
                    window.dashboard.addLog('qBittorrent 实例删除成功', 'success');
                    await window.dashboard.loadConfig();
                } else {
                    throw new Error('删除失败');
                }
            } catch (error) {
                window.dashboard.addLog('qBittorrent 实例删除失败: ' + error.message, 'error');
            }
        }

        // 初始化仪表板
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new QBControllerDashboard();
        });
    </script>
</body>
</html>

